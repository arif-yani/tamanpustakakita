from odoo import api, fields, models
import time
from datetime import datetime, timedelta
import requests
import json
from odoo.exceptions import UserError, ValidationError

class myfuture_paket(models.Model):
    _name = "myfuture.paket"
    _description = "My Future Paket"

    name = fields.Char('Nama')
    weight = fields.Float('Berat')
    remark = fields.Char('Catatan')
    is_titipan = fields.Boolean("Titipan", default=False)
    move_id = fields.Many2one('account.move', 'Move ID')
    ongkir_paket_state =  fields.Selection([('lunas','Lunas'), ('lunas_prev_invoice','Lunas Invoice Sebelumnya'),('belum_lunas','Belum Lunas')], string="Ongkir", default="belum_lunas")
    partner_id = fields.Many2one('res.partner', related="move_id.partner_id")
    parent_paket_id =  fields.Many2one('myfuture.paket','Paket Sebelumnya')
    is_hide_paket = fields.Boolean('Hide Paket', default=False)

    @api.onchange('ongkir_paket_state')
    def onchange_paket_status(self):
        if self.ongkir_paket_state == 'belum_lunas':
            self.is_titipan = True
            if self.parent_paket_id.ongkir_paket_state != 'belum_lunas':
                self.parent_paket_id.ongkir_paket_state = 'belum_lunas'
            print("check_masuk1")
        elif self.ongkir_paket_state == 'lunas' or self.ongkir_paket_state == 'lunas_prev_invoice':
            self.parent_paket_id.ongkir_paket_state = 'lunas'
            print("check_masuk2")



    def write_confirmed_paket(self, move):
        confirmed_paket = len([paket for paket in move.paket_line_ids if paket.ongkir_paket_state == 'lunas'])
        line_ongkir_id = self.env['account.move.line'].search([('move_id','=', move._origin.id),('name','=', 'Total Ongkir')], limit=1)
        if line_ongkir_id:
            if move.state != 'draft':
                move.button_draft()
            line_ongkir_id.quantity = confirmed_paket
            if isinstance(move.id, int):
                if move.state != 'posted':
                    move.line_ids.remove_move_reconcile()
                    move.action_post()
        return confirmed_paket

    def write(self, vals):
        res = super(myfuture_paket, self).write(vals)
        self.write_confirmed_paket(self.move_id)
        return res


class myfuture_sent_paket(models.Model):
    _name = "myfuture.sent.paket"

    name = fields.Char('Nama')
    paket_id = fields.Many2one("myfuture.paket", "Paket ID")
    check_out_time = fields.Datetime("Check Out Time")
    state = fields.Selection([('draft','Draft'),('check_out','Check Out'),('sent','Sent')])
    weight = fields.Float('Berat', related="paket_id.weight")
    sent_to = fields.Selection([('batam','Batam'), ('luar_batam','Luar Batam')])
    kecamatan_id = fields.Many2one("myfuture.kecamatan", "Location")
    remark = fields.Char('Catatan', related="paket_id.remark")
    address = fields.Char("Alamat", related="paket_id.partner_id.street")
    currency_id = fields.Many2one('res.currency', string='Currency', required=True,default=lambda self: self.env.user.company_id.currency_id)
    total_ongkir = fields.Monetary("Ongkir", compute="_compute_total_ongkir")

    def unlink(self):
        if not self.env.user.has_group("my_future_custom.group_admin"):
            raise ValidationError("Hanya Admin yang bisa menghapus record, silahkan hubungi administrator.")
        res = super().unlink()
        return res
    
    @api.depends("kecamatan_id")
    def _compute_total_ongkir(self):
        for line in self:
            ongkir_obj = self.env['myfuture.ongkir'].search([('kecamatan_id','=',line.kecamatan_id.id)],limit=1)
            if line.kecamatan_id.kota_id and line.kecamatan_id.kota_id.name.upper() == "KOTA BATAM":
                line.total_ongkir = 10000
            elif line.kecamatan_id and ongkir_obj:
                line.total_ongkir = ongkir_obj.price
            else:
                line.total_ongkir = False
