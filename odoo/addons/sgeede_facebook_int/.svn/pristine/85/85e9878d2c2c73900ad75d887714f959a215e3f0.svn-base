import json
import requests
from odoo import api, fields, models, tools, _, SUPERUSER_ID
from odoo.exceptions import UserError, ValidationError
from datetime import datetime, timedelta
from dateutil.relativedelta import relativedelta

class sgeede_facebook_get_post(models.TransientModel):
    _name = "sgeede.facebook.get.post"
    _description = "Facebook Get Post"

    page_id = fields.Many2one('sgeede.facebook.page', 'Page ID')

    def get_all_post(self):
        api_url = "https://graph.facebook.com/v19.0/"
        self.page_id.cron_generate_token_data()
        added_fields = "message,created_time,status_type,story,attachments{url,type}"
        api_get_post = api_url+self.page_id.page_id+"/feed?fields="+added_fields+"&access_token="+self.page_id.page_token
        headers = {
                'Content-Type':'application/json'
            }
        response_api = requests.get(api_get_post, headers=headers)
        post_json = response_api.json()
        if 'data' not in post_json:
            self.env['sgeede.facebook.api.log'].create({
                'name': 'Get Post',
                'page_id': self.page_id.id,
                'running_date': datetime.now(),
                'state': 'failed',
                'message': post_json,
            })
            return False
        self.env['sgeede.facebook.api.log'].create({
            'name': 'Get Post',
            'page_id': self.page_id.id,
            'running_date': datetime.now(),
            'state': 'success',
            'message': post_json,
        })
        return post_json['data']
    

    def create_post(self):
        datas = self.get_all_post()
        if datas:
            for data in datas:
                timestamp_str = data['created_time']
                formatted_timestamp = timestamp_str.replace("T", " ")
                formatted_timestamp = formatted_timestamp.replace("+0000", "")
                datetime_obj = datetime.strptime(formatted_timestamp, "%Y-%m-%d %H:%M:%S")
                

                underscore_index = data['id'].find("_")
                str_id_post = ""
                if underscore_index != -1:
                    str_id_post = data['id'][underscore_index + 1:]

                get_latest_post = self.env['sgeede.facebook.post'].search([('id_post','=', str_id_post)])
                if not get_latest_post:
                    post = self.env['sgeede.facebook.post'].create({
                        'name': data['id'],
                        'post_date': datetime_obj,
                        'type_post':data['status_type'],
                        'story':data['story'] if 'story' in data else '',
                        'message': data['message'],
                        'page_id': self.page_id.id,
                        'id_post': str_id_post,
                    })
                    if 'attachments' in data:
                        if 'data' in data['attachments']:
                            for attch in data['attachments']['data']:
                                self.env['sgeede.facebook.attachment'].create({
                                    'attachment_link': attch['url'],
                                    'attachment_type': attch['type'],
                                    'post_id': post.id,
                                })
                    self.env['sgeede.facebook.comment'].create_comment(post, self.page_id)
                else:
                    continue